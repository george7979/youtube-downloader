#!/bin/bash
# YouTube Downloader - Post-installation script
# Autor: george7979

# Bezpieczna funkcja curl z weryfikacjÄ… SSL
secure_curl() {
    local url="$1"
    local output="$2"
    
    # SprawdÅº czy curl jest dostÄ™pny
    if ! command -v curl >/dev/null 2>&1; then
        echo "âŒ BÅ‚Ä…d: curl nie jest dostÄ™pny"
        return 1
    fi
    
    # SprawdÅº czy certyfikaty SSL sÄ… dostÄ™pne
    if [ ! -f "/etc/ssl/certs/ca-certificates.crt" ]; then
        echo "âŒ BÅ‚Ä…d: Certyfikaty SSL nie sÄ… dostÄ™pne"
        return 1
    fi
    
    # Bezpieczne pobieranie z curl
    if [ -n "$output" ]; then
        curl --tlsv1.2 --proto '=https' --fail --silent --show-error \
            --cacert /etc/ssl/certs/ca-certificates.crt \
            --output "$output" "$url"
    else
        curl --tlsv1.2 --proto '=https' --fail --silent --show-error \
            --cacert /etc/ssl/certs/ca-certificates.crt \
            "$url"
    fi
    
    return $?
}

# Funkcja do bezpiecznego pobierania pip
install_pip_secure() {
    local python_cmd="$1"
    
    echo "ğŸ”’ Bezpieczne pobieranie pip..."
    
    # UtwÃ³rz tymczasowy plik
    local temp_file=$(mktemp)
    
    # Pobierz pip z weryfikacjÄ… SSL
    if secure_curl "https://bootstrap.pypa.io/get-pip.py" "$temp_file"; then
        # SprawdÅº czy plik zostaÅ‚ pobrany poprawnie
        if [ -s "$temp_file" ] && grep -q "import sys" "$temp_file"; then
            echo "âœ… Pip pobrany bezpiecznie"
            # Wykonaj pobrany skrypt
            "$python_cmd" "$temp_file"
            local result=$?
            rm -f "$temp_file"
            return $result
        else
            echo "âŒ BÅ‚Ä…d: Pobrany plik pip jest nieprawidÅ‚owy"
            rm -f "$temp_file"
            return 1
        fi
    else
        echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ pobraÄ‡ pip bezpiecznie"
        rm -f "$temp_file"
        return 1
    fi
}

echo "ğŸ¬ YouTube Downloader - Instalacja"
echo "=================================="

# Funkcja do czekania na zwolnienie blokady dpkg
wait_for_dpkg() {
    while fuser /var/lib/dpkg/lock >/dev/null 2>&1 || fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
        echo "â³ Czekam na zwolnienie blokady dpkg..."
        sleep 5
    done
}

# SprawdÅº czy Python jest zainstalowany
if ! command -v python3 >/dev/null 2>&1; then
    echo "ğŸ Python3 nie jest zainstalowany. Instalowanie..."
    wait_for_dpkg
    apt-get update
    apt-get install -y python3 python3-venv python3-pip python3-tk
fi

# SprawdÅº czy system jest gotowy do tworzenia venv
echo "ğŸ” Sprawdzanie gotowoÅ›ci systemu..."

# SprawdÅº czy venv jest dostÄ™pny
if ! python3 -c "import venv" 2>/dev/null; then
    echo "âš ï¸ python3-venv nie jest dostÄ™pny"
    echo "Instalowanie w tle..."
    nohup bash -c 'sleep 5; apt-get update && apt-get install -y python3-venv' >/dev/null 2>&1 &
fi

# SprawdÅº czy tkinter jest dostÄ™pny
if ! python3 -c "import tkinter" 2>/dev/null; then
    echo "âš ï¸ python3-tk nie jest dostÄ™pny"
    echo "Instalowanie w tle..."
    nohup bash -c 'sleep 5; apt-get update && apt-get install -y python3-tk' >/dev/null 2>&1 &
fi

# SprawdÅº czy pip jest dostÄ™pny
if ! python3 -c "import pip" 2>/dev/null; then
    echo "âš ï¸ pip nie jest dostÄ™pny"
    echo "Instalowanie pip przez bezpieczny curl..."
    install_pip_secure "python3"
fi

# SprawdÅº czy ffmpeg jest dostÄ™pny
if ! command -v ffmpeg >/dev/null 2>&1; then
    echo "âš ï¸ ffmpeg nie jest dostÄ™pny"
    echo "Instalowanie ffmpeg w tle..."
    nohup bash -c 'sleep 5; apt-get update && apt-get install -y ffmpeg' >/dev/null 2>&1 &
    echo "FFmpeg bÄ™dzie dostÄ™pny za kilka minut po zakoÅ„czeniu instalacji"
fi

# UtwÃ³rz Å›rodowisko wirtualne z lepszÄ… obsÅ‚ugÄ… bÅ‚Ä™dÃ³w
echo "ğŸ”§ Tworzenie Å›rodowiska wirtualnego..."

# PrÃ³buj standardowÄ… metodÄ™
if python3 -m venv /usr/share/youtube-downloader/venv 2>/dev/null; then
    echo "âœ… Åšrodowisko wirtualne utworzone pomyÅ›lnie"
else
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ utworzyÄ‡ Å›rodowiska wirtualnego"
    echo "PrÃ³bujÄ™ alternatywnÄ… metodÄ™..."
    
    # UsuÅ„ uszkodzone venv jeÅ›li istnieje
    rm -rf /usr/share/youtube-downloader/venv 2>/dev/null || true
    
    # PrÃ³buj z --without-pip
    if python3 -m venv --without-pip /usr/share/youtube-downloader/venv 2>/dev/null; then
        echo "âœ… Åšrodowisko wirtualne utworzone bez pip"
        # Zainstaluj pip w venv przez bezpieczny curl
        install_pip_secure "/usr/share/youtube-downloader/venv/bin/python"
    else
        echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ utworzyÄ‡ Å›rodowiska wirtualnego"
        echo "PrÃ³bujÄ™ rÄ™cznÄ… metodÄ™..."
        
        # RÄ™czne utworzenie venv
        mkdir -p /usr/share/youtube-downloader/venv/bin
        mkdir -p /usr/share/youtube-downloader/venv/lib/python3.*/site-packages
        mkdir -p /usr/share/youtube-downloader/venv/include
        
        # Skopiuj Python do venv
        cp $(which python3) /usr/share/youtube-downloader/venv/bin/python
        cp $(which python3) /usr/share/youtube-downloader/venv/bin/python3
        
        # UtwÃ³rz activate script
        cat > /usr/share/youtube-downloader/venv/bin/activate << 'EOF'
#!/bin/bash
export VIRTUAL_ENV="/usr/share/youtube-downloader/venv"
export PATH="$VIRTUAL_ENV/bin:$PATH"
unset PYTHONHOME
EOF
        chmod +x /usr/share/youtube-downloader/venv/bin/activate
        
        # Zainstaluj pip przez bezpieczny curl
        install_pip_secure "/usr/share/youtube-downloader/venv/bin/python"
    fi
fi

# SprawdÅº czy venv zostaÅ‚ utworzony poprawnie
if [ ! -d "/usr/share/youtube-downloader/venv" ] || [ ! -f "/usr/share/youtube-downloader/venv/bin/activate" ]; then
    echo "âŒ BÅ‚Ä…d krytyczny: Åšrodowisko wirtualne nie zostaÅ‚o utworzone"
    echo "PrÃ³bujÄ™ ponownie utworzyÄ‡ Å›rodowisko wirtualne..."
    
    # UsuÅ„ uszkodzone venv jeÅ›li istnieje
    rm -rf /usr/share/youtube-downloader/venv 2>/dev/null || true
    
    # SprÃ³buj ponownie utworzyÄ‡ venv
    if python3 -m venv /usr/share/youtube-downloader/venv 2>/dev/null; then
        echo "âœ… Åšrodowisko wirtualne utworzone ponownie"
    else
        echo "âŒ Nie udaÅ‚o siÄ™ utworzyÄ‡ Å›rodowiska wirtualnego"
        echo "Aplikacja moÅ¼e nie dziaÅ‚aÄ‡ poprawnie"
        echo "SprÃ³buj ponownie za kilka minut po zakoÅ„czeniu instalacji zaleÅ¼noÅ›ci"
    fi
fi

# Zainstaluj zaleÅ¼noÅ›ci w Å›rodowisku wirtualnym
echo "ğŸ“š Instalowanie zaleÅ¼noÅ›ci w Å›rodowisku wirtualnym..."
if /usr/share/youtube-downloader/venv/bin/pip install "yt-dlp>=2025.7.21" 2>/dev/null; then
    echo "âœ… ZaleÅ¼noÅ›ci zainstalowane pomyÅ›lnie"
else
    echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ zainstalowaÄ‡ zaleÅ¼noÅ›ci"
    echo "PrÃ³bujÄ™ ponownie..."
    /usr/share/youtube-downloader/venv/bin/pip install --upgrade pip
    if /usr/share/youtube-downloader/venv/bin/pip install "yt-dlp>=2025.7.21" 2>/dev/null; then
        echo "âœ… ZaleÅ¼noÅ›ci zainstalowane pomyÅ›lnie"
    else
        echo "âŒ BÅ‚Ä…d: Nie udaÅ‚o siÄ™ zainstalowaÄ‡ zaleÅ¼noÅ›ci"
        echo "Aplikacja moÅ¼e nie dziaÅ‚aÄ‡ poprawnie"
    fi
fi

# SprawdÅº czy zaleÅ¼noÅ›ci zostaÅ‚y zainstalowane poprawnie
echo "ğŸ” Sprawdzanie instalacji zaleÅ¼noÅ›ci..."
if /usr/share/youtube-downloader/venv/bin/python -c "import yt_dlp" 2>/dev/null; then
    echo "âœ… ZaleÅ¼noÅ›ci dziaÅ‚ajÄ… poprawnie"
else
    echo "âŒ BÅ‚Ä…d: ZaleÅ¼noÅ›ci nie dziaÅ‚ajÄ… poprawnie"
    echo "Instalowanie w tle..."
    nohup bash -c 'sleep 10; /usr/share/youtube-downloader/venv/bin/pip install "yt-dlp>=2025.7.21"' >/dev/null 2>&1 &
fi

# Aktualizuj ikony i desktop
if command -v update-icon-caches >/dev/null 2>&1; then
    update-icon-caches /usr/share/icons/hicolor
fi

if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications
fi

# Konfiguracja i logi bÄ™dÄ… zapisywane w /tmp/ (zawsze dostÄ™pny)
echo "ğŸ“ Konfiguracja i logi bÄ™dÄ… zapisywane w /tmp/"
echo "ğŸ”„ Dane bÄ™dÄ… dostÄ™pne do restartu systemu"

# UtwÃ³rz katalog logÃ³w uÅ¼ytkownika (dla kompatybilnoÅ›ci)
if [ -n "$SUDO_USER" ]; then
    USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
else
    USER_HOME=$HOME
fi

if [ -n "$USER_HOME" ] && [ -d "$USER_HOME" ]; then
    mkdir -p "$USER_HOME/.youtube-downloader" || true
fi

chmod 755 /usr/bin/youtube-downloader || true
chmod 644 /usr/share/applications/youtube-downloader.desktop || true

echo "âœ… YouTube Downloader v1.0.2 zostaÅ‚ zainstalowany pomyÅ›lnie!"
echo "ğŸš€ Uruchom aplikacjÄ™ komendÄ…: youtube-downloader"
echo "ğŸ“± Lub znajdÅº w menu aplikacji systemu"
echo "ğŸ“ Logi bÄ™dÄ… zapisywane w: ~/.youtube-downloader/youtube_downloader.log"
echo ""
echo "ğŸ”„ Instalowanie zaleÅ¼noÅ›ci w tle... (moÅ¼e potrwaÄ‡ kilka minut)"
echo "JeÅ›li aplikacja nie dziaÅ‚a, sprÃ³buj ponownie za kilka minut"
echo ""
echo "âš ï¸  UWAGA PRAWNA: Ta aplikacja jest narzÄ™dziem technicznym."
echo "UÅ¼ytkownik odpowiada za legalnoÅ›Ä‡ pobierania treÅ›ci."
